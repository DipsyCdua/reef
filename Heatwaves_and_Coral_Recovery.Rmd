---
title: "Heatwaves_and_Coral_Recovery"
author: "Chengxi"
date: "2025-04-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r}
library(DBI)
library(RPostgres)
library(RSQLite)
library(sf)
library(dplyr)
library(tidyr)
```





# use to load the data to db
```{r}
sqlite_con <- dbConnect(RSQLite::SQLite(), "D:/R_studio_working_dir/DATA3888_group/Heatwaves and Coral Recovery Database (HeatCRD) SQLITE.db")
```

# Must connect and disconect after use
```{r}
con <- dbConnect(
  RPostgres::Postgres(),
  dbname = "Heatwaves and Coral Recovery",
  host = "localhost",
  port = 5432,
  user = "postgres",
  password = "magic123"
)
```

# write data into db

```{r}
# List SQLite tables
tables <- dbListTables(sqlite_con)

# For each table, read from SQLite and write to PostgreSQL
for (tbl in tables) {
  data <- dbReadTable(sqlite_con, tbl)
  dbWriteTable(con, tbl, data, overwrite = TRUE)
}
```

```{r}
for (tbl in tables) {
  cat("Table:", tbl, "\n")
  cols <- dbListFields(sqlite_con, tbl)
  print(cols)
  cat("\n")
}
```


```{r}
cmd <- "SELECT * FROM \"Query_9_Time_Series_All_Variables\" 
        WHERE \"State_Island_Province_Name\" = 'Great Barrier Reef'"
result <- dbGetQuery(con, cmd)
result
```

```{r}
year_range <- dbGetQuery(con,'SELECT MAX("Date_Year"), MIN("Date_Year") FROM "Query_9_Time_Series_All_Variables\" WHERE \"State_Island_Province_Name\" = \'Great Barrier Reef\'')
year_range
```

```{r}
colnames(result)
```

```{r}
result %>%
  summarize(
    empty_month = sum(is.na(Date_Month) | Date_Month == ""),
    empty_day  = sum(is.na(Date_Day)  | Date_Year   == "")
  )
#it seems empty_month and empty_day appears in same row and there are 342 this kind of row
```

```{r}
result$Date_Year  <- as.integer(result$Date_Year)
result$Date_Month <- as.integer(result$Date_Month)
result$Date_Day   <- as.integer(result$Date_Day)

#result$Date_Day[ is.na(result$Date_Day) ] <- 1

result$Date <- as.Date(
  paste(result$Date_Year,
        result$Date_Month,
        result$Date_Day,
        sep = "-"),
  format = "%Y-%m-%d"
)
result
```

```{r}
result <- result %>% 
  filter(!is.na(Date))
result
```

```{r}
result$Latitude_Degrees  <- as.numeric(result$Latitude_Degrees)
result$Longitude_Degrees <- as.numeric(result$Longitude_Degrees)

result <- result[ !is.na(result$Latitude_Degrees) & 
                  !is.na(result$Longitude_Degrees), ]

result$geometry <- st_as_sfc(
  paste0(
    "POINT(",
      result$Longitude_Degrees, " ",
      result$Latitude_Degrees,
    ")"
  ),
  crs = 4326
)
result
```


# save into db

```{r}
result_sf <- st_as_sf(
  result,
  sf_column_name = "geometry",
  crs            = 4326
)

```

```{r}
result_sf
```

# please only execute once

```{r}
DBI::dbExecute(con, "CREATE EXTENSION IF NOT EXISTS postgis;")
DBI::dbExecute(con, "CREATE EXTENSION IF NOT EXISTS postgis_topology;")
```
```{r}
DBI::dbGetQuery(con, "SELECT * FROM pg_extension;")
```


```{r}
st_write(
  obj         = result_sf,
  dsn         = con,
  layer       = "coral_recovery_GBR", 
  delete_layer= TRUE
)
```



#not use below
#join Site_Description_tbl and Sample_Event_tbl and cover_tbl and Thermal_Stress_tbl by sample_id

```{r}
joined_df <- dbGetQuery(con, '
  SELECT
    sd.*,
    se."Sample_ID",
    se."Date_Day",
    se."Date_Month",
    se."Date_Year",
    se."Depth" AS "Event_Depth",
    se."Comments" AS "Event_Comments",
    c."Percent_Hard_Coral_Cover",
    c."Comments" AS "Cover_Comments",
    ts."ClimSST",
    ts."Temperature_Kelvin",
    ts."Temperature_Mean",
    ts."Temperature_Minimum",
    ts."Temperature_Maximum",
    ts."Temperature_Kelvin_Standard_Deviation",
    ts."Windspeed",
    ts."SSTA",
    ts."SSTA_Mean",
    ts."SSTA_Minimum",
    ts."SSTA_Maximum",
    ts."SSTA_DHW",
    ts."TSA",
    ts."TSA_Mean",
    ts."TSA_DHWMean"
  FROM "Thermal_Stress_tbl" AS ts
  JOIN "Cover_tbl" AS c  ON ts."Sample_ID"  = c."Sample_ID"
  JOIN "Sample_Event_tbl" AS se ON c."Sample_ID"   = se."Sample_ID"
  JOIN "Site_Description_tbl" AS sd ON se."Site_ID" = sd."Site_ID"
  ORDER BY "Date_Year"
')

joined_df

```

```{r}
new_table_name <- "joined_coral_thermal_data"
dbWriteTable(con, new_table_name, joined_df, overwrite = TRUE)

cat("New table '", new_table_name, "' has been created in the database.\n", sep = "")
```

```{r}
year_range <- dbGetQuery(con,'SELECT MAX("Date_Year"), MIN("Date_Year") FROM "joined_coral_thermal_data"')
year_range
```

```{r}
joined_df$Event_Date <- as.Date(
  with(joined_df, paste(Date_Year, Date_Month, Date_Day, sep = "-")),
  format = "%Y-%m-%d"
)

joined_df
```

```{r}
joined_df$geometry <- st_as_sfc(
  paste0("POINT(", joined_df$Longitude_Degrees, " ", joined_df$Latitude_Degrees, ")"),
  crs = 4326
)

joined_df
```

